<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>mypage</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/main.css" rel="stylesheet">
    <style>
        @keyframes fadeOut {
         from {
             opacity: 1;
         }
         to {
             opacity: 0;
         }
     }

     #successMessage {
         animation: fadeOut 1s ease-out 2s forwards;
     }
    </style>
</head>
<body>
<div th:replace="~{ nav.html::navbar }"></div>
<!--<div sec:authentication="principal"></div>-->
<!--<div sec:authentication="principal.username"></div>-->
<!--<div sec:authorize="hasAuthority('일반유저')">-->
<!--<div sec:authorize="isAnonymous()">-->
<!--    <h3>이 유저는 일반 유저 권한입니다.</h3>-->
<!--</div>-->

<div class="container my-area">
    <h2><i class='bx bxs-user-circle my-con' ></i> My Page</h2>
    <p>아이디 <span class="bold-text" th:text="${username}"></span></p>
    <p>닉네임 <span class="bold-text" th:text="${displayName}"></span></p>
    <button class="accordion">주문 내역</button>
    <div class="panel">
        <p th:if="${!sales.isEmpty()}">
            <span th:each="sale : ${sales}">
                주문 번호: <span th:text="${sale.id}"></span> 상품명: <span th:text="${sale.itemName}"></span> 가격: <span th:text="${sale.price}+'원'"></span><br>
            </span>
        </p>
        <p th:if="${sales.isEmpty()}">주문 내역이 없습니다.</p>
    </div>
    <button class="accordion">내가 작성한 리뷰</button>
    <div class="panel">
        <p th:if="${!reviews.isEmpty()}">
            <span th:each="review : ${reviews}">
                리뷰 번호: <span th:text="${review.id}"></span> 내용: <span th:text="${review.content}"></span><br>
            </span>
        </p>
        <p th:if="${reviews.isEmpty()}">작성한 리뷰가 없습니다.</p>
    </div>
    <button class="accordion">나의 정보 수정</button>
    <div class="panel">
        <form action="/update-nickname" method="post" onsubmit="return validateForm()">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <label for="displayName">닉네임</label>
            <input type="text" id="displayName" name="displayName" placeholder="수정할 닉네임" th:value="${displayName}">
            <label for="password">비밀번호</label>
            <input type="password" id="password" name="password" placeholder="수정할 비밀번호">
            <input type="submit" value="업데이트하기">
        </form>
    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // 알림 메시지를 가져와서 표시
    var message = /*[[${message}]]*/ null;
    console.log("Message:", message);
    if (message) {
        alert(message);
    }
    /*]]>*/
</script>

<script>
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
                panel.style.display = "none";
            } else {
                panel.style.display = "block";
            }
        });
    }


function validateForm() {
    var displayName = document.getElementById("displayName").value.trim();
    var password = document.getElementById("password").value.trim();

    if (displayName === "" || password === "") {
        alert("수정할 닉네임과 패스워드 모두 입력해주세요.");
        return false;
    }
    // 이렇게 해도 스페이스바 검증 못하는 이유 ?!
    let hasSpaceDisplayName = displayName.includes(" ");
    let hasSpacePassword = password.includes(" ");

    if (hasSpaceDisplayName || hasSpacePassword) {
        alert("닉네임과 패스워드에는 스페이스바가 포함될 수 없습니다.");
        return false;
    }

    var displayNamePattern = /^[가-힣a-zA-Z]*$/;
    if (!displayNamePattern.test(displayName)) {
        alert("닉네임은 한글 또는 알파벳 문자로만 이루어져야 합니다.");
        document.getElementById("displayName").focus();
        return false;
    }

    var passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
    if (!passwordPattern.test(password)) {
        alert("비밀번호는 대소문자를 포함한 알파벳과 숫자, 특수문자를 포함하여 8자 이상이어야 합니다.");
        document.getElementById("password").focus();
        return false;
    }

    return true;
}
</script>
</body>
</html>